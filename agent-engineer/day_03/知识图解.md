# Day 3 知识图解：生成器工程化应用可视化

## 图1：生成器状态机与执行流程

```mermaid
stateDiagram-v2
    [*] --> Created : 调用生成器函数
    Created --> Running : next() / send(None)
    
    state Running {
        [*] --> Executing
        Executing --> Yielding : yield expression
        Yielding --> Suspended : 交出控制权
        Suspended --> Executing : next() / send(value)
        Executing --> [*] : return / StopIteration
    }
    
    Suspended --> [*] : close()
    Running --> [*] : 正常结束
    Created --> [*] : close()

    note left of Created
        生成器对象创建
        但未开始执行
        内存中保存函数定义
    end note
    
    note right of Yielding
        关键操作：
        1. 计算expression值
        2. 冻结执行帧
        3. 返回值给调用者
    end note
    
    note left of Suspended
        状态保持：
        - 局部变量值
        - 指令指针位置
        - 栈帧信息
        等待下次唤醒
    end note
```

**执行时序说明**：

1. **创建阶段**：调用生成器函数返回生成器对象，代码未执行
2. **首次唤醒**：调用`next(gen)`进入Running状态，执行到第一个`yield`
3. **产出值**：计算yield表达式，返回值，转入Suspended状态
4. **恢复执行**：再次调用`next(gen)`或`gen.send(value)`，从yield后继续
5. **循环**：重复3-4步骤，直到函数返回或抛出StopIteration
6. **异常处理**：调用`gen.close()`可提前终止，清理资源

## 图2：流式RAG生成器管道架构

```mermaid
flowchart TD
    User[用户查询] --> Preprocess[预处理模块]
    
    subgraph RetrievalStage [检索阶段]
        Preprocess --> Embed[查询向量化]
        Embed --> VecSearch[向量检索]
        Preprocess --> KeywordExtract[关键词提取]
        KeywordExtract --> TextSearch[文本检索]
        VecSearch --> Fusion[多路融合]
        TextSearch --> Fusion
    end
    
    Fusion --> Rerank[重排序引擎]
    
    subgraph GenerationStage [生成阶段]
        Rerank --> ContextBuilder[上下文构建]
        ContextBuilder --> PromptEngine[提示工程]
        PromptEngine --> LLMStream[LLM流式生成]
        LLMStream --> TokenBuffer[Token缓冲]
        TokenBuffer --> StreamOut[流式输出]
    end
    
    StreamOut --> Client[客户端<br/>实时渲染]
    
    subgraph DataPipeline [数据管道]
        DocSource[文档源] --> Chunker[智能分块器]
        Chunker --> Embedder[嵌入模型]
        Embedder --> VectorDB[(向量数据库)]
        Chunker --> TextDB[(文本索引)]
    end
    
    VectorDB --> VecSearch
    TextDB --> TextSearch
    
    style RetrievalStage fill:#e1f5fe
    style GenerationStage fill:#f3e5f5
    style DataPipeline fill:#e8f5e8
```

**组件说明**：

- **智能分块器**：基于DeepDoc等深度文档理解，识别标题、段落、表格、图片
- **多路融合**：结合向量检索（语义相似度）与文本检索（关键词匹配）
- **重排序引擎**：使用交叉编码器（Cross-Encoder）精细排序，如BGE-Reranker
- **LLM流式生成**：异步生成器逐Token产出，支持打字机效果
- **Token缓冲**：管理网络抖动，平滑输出速率

## 图3：Python生成器 vs Java Stream API对比（设计哲学）

```mermaid
quadrantChart
    title "Python Generator vs Java Stream API: 设计哲学对比"
    x-axis "声明式 ← 编程范式 → 命令式" 
    y-axis "批处理 ← 适用场景 → 实时流"
    
    "Java Stream": [0.2, 0.8]
    "Python Generator": [0.7, 0.3]
    
    "Spark/Flink": [0.1, 0.9]
    "Async/Await": [0.8, 0.2]
    
    "高吞吐批处理": [0.15, 0.85]
    "交互式对话": [0.85, 0.15]
```

**核心差异分析**：

| 特性         | Java Stream            | Python Generator             |
| ------------ | ---------------------- | ---------------------------- |
| **数据模型** | 集合→管道→终端操作     | 可暂停函数→惰性序列          |
| **并发支持** | 并行流（ForkJoinPool） | 异步生成器（asyncio）        |
| **状态管理** | 无状态操作链           | 函数帧完整状态保存           |
| **错误处理** | 终端操作抛出异常       | 可在yield点捕获恢复          |
| **内存模式** | 有状态操作需全量缓存   | 始终增量生成O(1)             |
| **适用场景** | ETL流水线、数据分析    | 实时聊天、流式API、I/O密集型 |

## 图4：企业级流式RAG系统部署拓扑

```mermaid
graph TB
    subgraph "前端层"
        Web[Web应用] --> WS[WebSocket网关]
        Mobile[移动端] --> WS
    end
    
    subgraph "网关层"
        WS --> LoadBalancer[负载均衡器]
        LoadBalancer --> APIGroup[API服务集群]
    end
    
    subgraph "业务层"
        APIGroup --> RAGService[RAG微服务]
        RAGService --> Cache[(Redis缓存)]
        RAGService --> VectorCluster[(向量数据库集群)]
        RAGService --> RerankGPU[GPU重排序服务]
    end
    
    subgraph "数据层"
        VectorCluster --> EmbedWorker[嵌入计算Worker]
        EmbedWorker --> DocStorage[(文档存储)]
        DocStorage --> MQ[消息队列<br/>Kafka/Pulsar]
    end
    
    subgraph "监控层"
        Prometheus[Prometheus指标采集] --> Grafana[Grafana看板]
        APIGroup --> Jaeger[Jaeger分布式追踪]
        RAGService --> LangSmith[LangSmith可观测性]
    end
    
    style 前端层 fill:#bbdefb
    style 网关层 fill:#c8e6c9
    style 业务层 fill:#fff9c4
    style 数据层 fill:#f8bbd0
    style 监控层 fill:#d1c4e9
```

**企业级考量**：

1. **水平扩展**：API服务无状态，可横向扩展应对高并发
2. **GPU加速**：重排序、嵌入计算卸载到专用GPU节点
3. **最终一致性**：文档更新通过消息队列异步同步到向量库
4. **可观测性**：全链路追踪、Token消耗监控、响应延迟告警
