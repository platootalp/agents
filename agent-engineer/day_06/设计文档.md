# Day6：简单Agent应用生产级实践 - 设计文档

## 1. 概述

### 1.1 目标
基于文档Day6框架，实现一个带工具的生产级Agent应用，强制包含：
- RBAC权限引擎：基于OPA（Open Policy Agent）实现权限控制
- 结构化审计日志：JSON格式日志系统
- 实时Token成本监控：多模型Token计数、成本预测、预算控制
- 生产级特性：失败降级链、安全防护、可观测性

### 1.2 核心要求
1. Agent必须成功调用至少3个工具（计算器、网络搜索、文件读写）
2. RBAC权限引擎必须拦截所有违规操作，审计日志完整性100%
3. Token成本监控必须准确计算多模型消耗，误差率 < 5%
4. 生产级特性全部实现：
   - 失败降级链触发时间 < 2秒
   - 敏感信息拦截率100%
   - 可观测性埋点覆盖率 > 90%
5. 代码必须通过基础安全扫描（OWASP Top 10规则）和性能测试（响应延迟P95 < 3秒）

## 2. 系统架构

### 2.1 整体架构图
```
┌─────────────────────────────────────────────────────────┐
│                   用户请求层                             │
└──────────────────────────┬──────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                 API网关层 (FastAPI)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 认证/授权模块 │  │ 请求限流模块 │  │ 输入验证模块 │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────────┬──────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                Agent核心层 (LangChain)                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ RBAC权限引擎 │  │ 工具调度器   │  │ 记忆管理器   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 成本监控器   │  │ 审计日志器   │  │ 降级控制器   │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└──────────────────────────┬──────────────────────────────┘
                           ↓
┌─────────────────────────────────────────────────────────┐
│                   工具执行层                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ 计算器工具   │  │ 网络搜索工具 │  │ 文件读写工具 │  │
│  └──────────────┘  └──────────────┘  └──────────────┘  │
└─────────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 RBAC权限引擎
- **架构**：基于OPA策略引擎的简化实现
- **模型**：
  - 用户（User）：具体操作者
  - 角色（Role）：权限集合（admin、user、guest）
  - 权限（Permission）：资源+操作（如：tool:calculator:execute）
- **策略语言**：Rego简化版，支持动态策略评估
- **Java经验迁移**：借鉴Spring Security的权限注解机制

#### 2.2.2 结构化审计日志系统
- **格式**：JSON格式，包含完整请求上下文
- **字段**：
  ```json
  {
    "timestamp": "ISO8601时间",
    "user_id": "用户ID",
    "session_id": "会话ID",
    "operation": "操作类型",
    "resource": "资源标识",
    "input": "用户输入（脱敏后）",
    "output": "Agent响应",
    "token_usage": {
      "prompt_tokens": 100,
      "completion_tokens": 200,
      "total_tokens": 300,
      "cost_usd": 0.001
    },
    "response_time_ms": 1500,
    "permission_check": {
      "allowed": true,
      "roles": ["user"],
      "policies": ["tool_access"]
    },
    "security_events": ["敏感词检测"],
    "error": null
  }
  ```
- **Java经验迁移**：借鉴Log4j的MDC（Mapped Diagnostic Context）机制

#### 2.2.3 Token成本监控系统
- **支持模型**：GPT-4、GLM-4、Claude-3、DeepSeek
- **核心功能**：
  1. 实时Token计数（基于tiktoken扩展）
  2. 成本预测算法（线性回归模型）
  3. 预算控制面板（实时预警）
  4. 多Provider成本对比
- **Java经验迁移**：借鉴Micrometer的指标收集机制

#### 2.2.4 失败降级链
- **三级降级策略**：
  1. **精确工具**：首选专用工具执行
  2. **通用工具**：降级到通用工具（如：纯LLM生成）
  3. **生成模式**：最终降级到基础生成模式
- **触发条件**：工具调用失败、超时、权限拒绝
- **降级时间**：< 2秒

## 3. 详细设计

### 3.1 Agent工具集

#### 3.1.1 计算器工具
```python
class CalculatorTool:
    """安全数学计算器工具"""
    
    def execute(self, expression: str) -> str:
        # 安全检查：防止代码注入
        # 支持基本运算：+ - * / ( )
        # 返回计算结果或错误信息
```

#### 3.1.2 网络搜索工具（模拟）
```python
class WebSearchTool:
    """模拟网络搜索工具"""
    
    def execute(self, query: str) -> str:
        # 模拟搜索过程
        # 返回格式化搜索结果
        # 记录搜索日志
```

#### 3.1.3 文件读写工具
```python
class FileIOTool:
    """安全文件读写工具"""
    
    def read(self, filepath: str) -> str:
        # 路径安全检查
        # 文件类型检查
        # 返回文件内容或错误
        
    def write(self, filepath: str, content: str) -> str:
        # 路径安全检查
        # 内容安全检查（敏感信息检测）
        # 写入文件并返回状态
```

### 3.2 RBAC权限引擎实现

#### 3.2.1 策略定义
```python
# RBAC策略配置
RBAC_POLICIES = {
    "admin": {
        "resources": ["*"],
        "actions": ["*"]
    },
    "user": {
        "resources": ["tool:calculator", "tool:websearch"],
        "actions": ["execute"]
    },
    "guest": {
        "resources": ["tool:calculator"],
        "actions": ["execute"]
    }
}
```

#### 3.2.2 权限检查器
```python
class RBACAuthorizer:
    """RBAC权限检查器"""
    
    def check_permission(self, user: User, resource: str, action: str) -> bool:
        # 基于用户角色检查权限
        # 支持通配符匹配
        # 记录权限检查日志
```

### 3.3 审计日志系统

#### 3.3.1 日志收集器
```python
class AuditLogger:
    """结构化审计日志收集器"""
    
    def log_request(self, request_context: dict):
        # 收集请求上下文
        # 格式化为JSON
        # 写入日志文件/发送到日志服务
```

### 3.4 Token成本监控

#### 3.4.1 Token计数器
```python
class TokenCounter:
    """多模型Token计数器"""
    
    def count_tokens(self, text: str, model: str) -> dict:
        # 基于模型选择计数方法
        # 返回prompt/completion/total tokens
```

#### 3.4.2 成本计算器
```python
class CostCalculator:
    """实时成本计算器"""
    
    def calculate_cost(self, tokens: dict, model: str) -> float:
        # 基于模型定价计算成本
        # 支持多Provider价格对比
```

## 4. 生产级特性

### 4.1 安全防护
1. **输入验证**：防止注入攻击
2. **敏感信息脱敏**：正则+NER实体识别
3. **权限控制**：最小权限原则
4. **审计追踪**：完整操作记录

### 4.2 可观测性
1. **指标收集**：请求数、延迟、错误率
2. **分布式追踪**：请求全链路追踪
3. **日志聚合**：结构化日志收集
4. **告警系统**：异常自动告警

### 4.3 容错与降级
1. **健康检查**：服务健康状态监控
2. **熔断机制**：故障自动隔离
3. **降级策略**：优雅降级保证可用性
4. **重试机制**：临时故障自动重试

## 5. Java经验迁移对照

| Java经验 | Agent实现 | 迁移点 |
|---------|-----------|--------|
| Spring Security | RBAC权限引擎 | 权限注解、策略评估 |
| Log4j MDC | 结构化审计日志 | 请求上下文传递 |
| Micrometer | Token成本监控 | 指标收集与展示 |
| Hystrix | 失败降级链 | 熔断降级策略 |
| Spring Cloud Gateway | API网关层 | 认证限流路由 |

## 6. 验收标准验证

### 6.1 功能验证
1. **工具调用测试**：至少3个工具，准确率 > 85%
2. **权限拦截测试**：违规操作拦截率100%
3. **成本监控测试**：Token计算误差率 < 5%
4. **降级链测试**：降级触发时间 < 2秒

### 6.2 性能测试
1. **响应延迟**：P95 < 3秒
2. **并发处理**：支持至少10并发请求
3. **资源使用**：内存<500MB，CPU<30%

### 6.3 安全测试
1. **OWASP扫描**：通过Top 10规则检查
2. **敏感信息防护**：拦截率100%
3. **审计完整性**：日志完整性100%

## 7. 交付物清单

1. **可部署Agent应用代码**：完整Python项目
2. **RBAC权限管理模块**：支持动态策略配置
3. **审计日志系统**：JSON格式日志收集
4. **Token成本监控面板**：实时数据可视化
5. **生产级特性实现报告**：详细实现说明
6. **Jupyter Notebook核心源码**：交互式演示
7. **测试用例集**：单元测试、集成测试
8. **部署配置**：Dockerfile、requirements.txt

## 8. 后续扩展建议

1. **集成真实OPA**：替换简化实现
2. **添加更多工具**：扩展Agent能力
3. **多语言支持**：支持Java、Go等语言调用
4. **云端部署**：支持Kubernetes部署
5. **机器学习优化**：基于历史数据优化成本预测

---

*设计完成时间：2026-01-31*
*设计者：扣子（Worker Agent）*
*版本：v1.0*